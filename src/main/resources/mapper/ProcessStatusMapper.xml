<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper    
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.hse.mapper.ProcessStatusMapper">
	<!-- 查询待办信息 -->
	<select id="findToDo"  parameterType="Map" resultType = "Map">
		SELECT
			c.checkForm,
			t.stepName,
			c.projNo,
			c.recordNo,
			c.draftDate,
			c.draftPerson
		FROM
			checkList c
			RIGHT JOIN instanceRelation r ON c.id = r.checkId
			RIGHT JOIN flowActionTrace t ON t.instanceId = r.instanceId
		<where>
			t.ownerUserId = #{ownerUserId} 
			AND t.submitUserId IS NULL
			AND c.isDel = '0'
		</where>
			order by draftDate desc
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询待办个数 -->
	<select id="findCountToDo"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList c
			RIGHT JOIN instanceRelation r ON c.id = r.checkId
			RIGHT JOIN flowActionTrace t ON t.instanceId = r.instanceId
		<where>
			t.ownerUserId = #{ownerUserId} 
			AND t.submitUserId IS NULL
			AND c.isDel = '0'
		</where>
	</select>
	
	<!-- 查询已办信息 -->
	<select id="findHaveToDo"  parameterType="Map" resultType = "Map">
		SELECT
			c.checkForm,t.stepName,c.projNo,c.recordNo,c.draftDate,c.draftPerson
		FROM
			checkList c
		RIGHT  JOIN instanceRelation r ON c.id = r.checkId
		RIGHT join flowActionTrace t	on t.instanceId=r.instanceId
		<where>
			t.submitUserId = #{ownerUserId} 
			AND c.isDel = '0'
		</where>
			 order by draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询已办个数 -->
	<select id="findCountHaveToDo"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList c
		RIGHT  JOIN instanceRelation r ON c.id = r.checkId
		RIGHT join flowActionTrace t	on t.instanceId=r.instanceId
		<where>
			t.submitUserId = #{ownerUserId} 
			AND c.isDel = '0'
		</where>
	</select>
	
	
	<!-- 查询流转信息 -->
	<select id="findCirculation"  parameterType="Map" resultType = "Map">
			SELECT
				c.checkForm,t.stepName,c.projNo,c.recordNo,c.draftDate,c.draftPerson
			FROM
				flowInstance i
			JOIN instanceRelation cil ON i.id = cil.instanceId
			JOIN checkList c ON c.id = cil.checkId
			JOIN flowActionTrace t ON i.id = t.instanceId
			<where>
				 i.userId = #{ownerUserId}
				AND (
					t.submitUserId IS NULL
					OR t.stepId = 300
				)
				AND c.isDel = '0'
			</where>
			 order by draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询流转信息个数 -->
	<select id="findCountCirculation"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
				flowInstance i
			JOIN instanceRelation cil ON i.id = cil.instanceId
			JOIN checkList c ON c.id = cil.checkId
			JOIN flowActionTrace t ON i.id = t.instanceId
			<where>
				 i.userId = #{ownerUserId}
				AND (
					t.submitUserId IS NULL
					OR t.stepId = 300
				)
				AND c.isDel = '0'
			</where>
	</select>
	
	
	<!-- 查询草稿信息 -->
	<select id="findDraft"  parameterType="Map" resultType = "Map">
			SELECT
				checkForm,
				projNo,
				recordNo,
				draftDate,
				draftPerson
			FROM
				checkList 
			<where>
			 	userId =  #{ownerUserId}
				AND isDel = '0'
				AND state = '0'
			</where>
			 order by draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询草稿信息个数 -->
	<select id="findCountDraft"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList 
		<where>
		 	userId =  #{ownerUserId}
			AND isDel = '0'
			AND state = '0'
		</where>
	</select>
	
</mapper>