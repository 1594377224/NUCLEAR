<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper    
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.hse.mapper.ProcessStatusMapper">
	<!-- 查询待办信息 -->
	<select id="findToDo"  parameterType="Map" resultType = "Map">
		SELECT
			d.id AS dangerId,
			t.stepName,
			t.stepId,
			t.id AS actionTraceId,
			t.instanceId,
			t.flowId,
			t.flowName,
			t.flowCode,
			t.stepCode,
			c.projNo,
			c.checkDate,
			c.checkForm,
			c.checkContent,
			c.approvePerson,
			c.approveDate,
			c.checkPerson,
			c.draftUnit,
			c.draftDept,
			c.draftPerson,
			c.draftDate,
			c.approvePerson,
			c.approveDate,
			c.id,
			c.recordNo
		FROM
			checkList c
			RIGHT JOIN instanceRelation r ON c.id = r.checkId
			JOIN checkAndDanger cd ON c.id = cd.checkId
			JOIN dangerList d ON d.id = cd.dangerId
			RIGHT JOIN flowActionTrace t ON t.instanceId = r.instanceId
		<where>
			t.ownerUserId = #{ownerUserId} 
			AND t.submitUserId IS NULL
			AND c.isDel = '0'
		</where>
			order by draftDate desc
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询待办个数 -->
	<select id="findCountToDo"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList c
			RIGHT JOIN instanceRelation r ON c.id = r.checkId
			RIGHT JOIN flowActionTrace t ON t.instanceId = r.instanceId
		<where>
			t.ownerUserId = #{ownerUserId} 
			AND t.submitUserId IS NULL
			AND c.isDel = '0'
		</where>
	</select>
	
	<!-- 查询已办信息 -->
	<select id="findHaveToDo"  parameterType="Map" resultType = "Map">
		SELECT
			t.stepName,
			t.stepId,
			t.id as actionTraceId,
			c.projNo,
			c.checkDate,
			c.checkForm,
			c.checkContent,
			c.approvePerson,
			c.approveDate,
			c.checkPerson,
			c.draftUnit,
			c.draftDept,
			c.draftPerson,
			c.draftDate,
			c.approvePerson,
			c.approveDate,
			c.id,
			c.recordNo
		FROM
			checkList c
		RIGHT  JOIN instanceRelation r ON c.id = r.checkId
		RIGHT join flowActionTrace t	on t.instanceId=r.instanceId
		<where>
			t.submitUserId = #{ownerUserId} 
			AND c.isDel = '0'
		</where>
			 order by draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询已办个数 -->
	<select id="findCountHaveToDo"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList c
		RIGHT  JOIN instanceRelation r ON c.id = r.checkId
		RIGHT join flowActionTrace t	on t.instanceId=r.instanceId
		<where>
			t.submitUserId = #{ownerUserId} 
			AND c.isDel = '0'
		</where>
	</select>
	
	
	<!-- 查询流转信息 -->
	<select id="findCirculation"  parameterType="Map" resultType = "Map">
			SELECT
				t.stepName,
				t.stepId,
				t.id as actionTraceId,
				c.projNo,
				c.checkDate,
				c.checkForm,
				c.checkContent,
				c.approvePerson,
				c.approveDate,
				c.checkPerson,
				c.draftUnit,
				c.draftDept,
				c.draftPerson,
				c.draftDate,
				c.approvePerson,
				c.approveDate,
				c.id,
			c.recordNo
			FROM
				flowInstance i
			JOIN instanceRelation cil ON i.id = cil.instanceId
			JOIN checkList c ON c.id = cil.checkId
			JOIN flowActionTrace t ON i.id = t.instanceId
			<where>
				 i.userId = #{ownerUserId}
				AND (
					t.submitUserId IS NULL
					OR t.stepId = 300
				)
				AND c.isDel = '0'
			</where>
			 order by draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询流转信息个数 -->
	<select id="findCountCirculation"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
				flowInstance i
			JOIN instanceRelation cil ON i.id = cil.instanceId
			JOIN checkList c ON c.id = cil.checkId
			JOIN flowActionTrace t ON i.id = t.instanceId
			<where>
				 i.userId = #{ownerUserId}
				AND (
					t.submitUserId IS NULL
					OR t.stepId = 300
				)
				AND c.isDel = '0'
			</where>
	</select>
	
	
	<!-- 查询草稿信息 -->
	<select id="findDraft"  parameterType="Map" resultType = "Map">
			SELECT
				d.id AS dangerId,
				c.projNo,
				c.checkDate,
				c.checkForm,
				c.checkContent,
				c.approvePerson,
				c.approveDate,
				c.checkPerson,
				c.draftUnit,
				c.draftDept,
				c.draftPerson,
				c.draftDate,
				c.approvePerson,
				c.approveDate,
				c.id,
				c.recordNo
			FROM
				checkList c
			JOIN checkAndDanger cd ON c.id = cd.checkId
			JOIN dangerList d ON d.id = cd.dangerId
			<where>
			 	c.userId =  #{ownerUserId}
				AND c.isDel = '0'
				AND c.state = '0'
			</where>
			 order by c.draftDate desc 
		 <if test="limit!= null and limit!= '' ">
			limit #{start},#{limit}
		</if> 
	</select>
	<!-- 查询草稿信息个数 -->
	<select id="findCountDraft"  parameterType="Map" resultType = "int">
		select 
			count(1) 
		FROM
			checkList 
		<where>
		 	userId =  #{ownerUserId}
			AND isDel = '0'
			AND state = '0'
		</where>
	</select>
	
	<!-- 查询流转信息 -->
	<select id="findTransferInformation"  parameterType="Map" resultType = "Map">
			SELECT
				t.ownerUserName,
				t.stepName,
				t.arriveTime,
				t.submitUserId,
				t.actionName
			FROM
				checkList c
			RIGHT JOIN instanceRelation r ON c.id = r.checkId
			RIGHT JOIN flowActionTrace t ON t.instanceId = r.instanceId
		<where>
		 	c.recordNo = #{recordNo}
		</where>
			order by arriveTime desc 
 	</select>
	
</mapper>